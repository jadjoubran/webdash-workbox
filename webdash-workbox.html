<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/empty-state-webdash/empty-state-webdash.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-toast/paper-toast.html">
<link rel="import" href="/bower_components/paper-spinner/paper-spinner-lite.html">

<dom-module id="webdash-workbox">
  <template>
    <style>
      :host {
        display: block;
      }

      .brand {
        background-color: var(--brand);
      }

      .text-center {
        text-align: center;
      }

      [hidden] {
        display: none;
      }

      .empty-state-cta {
        position: relative;
        top: -20px;
        margin-bottom: 20px;
        padding-left: 20px;
        padding-right: 20px;
      }

      .empty-state-cta paper-spinner-lite {
        margin-right: 20px;
      }

      paper-spinner-lite {
        width: 20px;
        height: 20px;
      }

      paper-button[disabled] {
        color: white;
        opacity: 0.6;
      }

      paper-dialog {
        z-index: 10000;
      }
    </style>

    <div id="plugin">

      <template is="dom-if" if="{{!workboxInstalled}}">
        <empty-state-webdash title="Workbox is not installed">
          Workbox needs to be installed in your project. Let's start by installing it.
        </empty-state-webdash>
        <div class="text-center">
          <paper-button class="brand empty-state-cta" on-click="installWorkbox" disabled$="{{installingWorkbox}}">
            <paper-spinner-lite active$="{{installingWorkbox}}" hidden$="{{!installingWorkbox}}"></paper-spinner-lite>
            Install workbox
          </paper-button>
        </div>
      </template>

      <template is="dom-if" if="{{showConfigGenerator}}">
        <empty-state-webdash title="Setup Workbox configuration">
          Let's start by generating your workbox config
        </empty-state-webdash>
      </template>

    </div>

    <paper-toast id="toast" class="fit-bottom"></paper-toast>

  </template>

  <script>
    class WebdashWorkbox extends Polymer.Element {
      static get is() { return 'webdash-workbox'; }

      ready() {
        super.ready();
        this.backend = new Backend(WebdashWorkbox.is);
        this.installingWorkbox = false;
        this.init();
      }

      init() {
        this.backend.get('init')
          .then(response => {
            this.configExists = response.configExists;
            this.workboxInstalled = response.workboxInstalled;

            this.showConfigGenerator = this.workboxInstalled && !this.configExists;
          });
      }

      installWorkbox() {
        this.installingWorkbox = true;
        this.backend.post('install')
          .then((response) => {
            if (response && response.result) {
              const toast = this.$.toast;
              toast.text = "Workbox successfully installed";
              toast.fitInto = this.$.plugin;
              toast.open();
              this.init();
            }
          })
          .finally(() => {
            this.installingWorkbox = false;
          });
      }
    }

    window.customElements.define(WebdashWorkbox.is, WebdashWorkbox);
  </script>
</dom-module>